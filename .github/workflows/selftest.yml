name: Core314 Smart Agent Selftest

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  selftest:
    runs-on: ubuntu-latest
    env:
      SELFTEST_FUNCTION_URL: ${{ secrets.SELFTEST_FUNCTION_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Run AI Agent Selftest
        run: |
          set -euo pipefail
          
          # Verify secrets are configured
          if [ -z "${SELFTEST_FUNCTION_URL:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "::error::Missing required secrets. Please configure SELFTEST_FUNCTION_URL and SUPABASE_SERVICE_ROLE_KEY in repository settings."
            echo "::error::Go to: https://github.com/core314system-lgtm/core314-platform/settings/secrets/actions"
            exit 2
          fi
          
          echo "Running Core314 Smart Agent Selftest..."
          echo "Secrets configured: âœ“"
          
          # Call selftest function
          response=$(curl -sS -f -X POST "$SELFTEST_FUNCTION_URL" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}" || true)
          
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2 || echo "0")
          body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "HTTP Status: $http_status"
          echo "Response Body:"
          echo "$body" | jq . 2>/dev/null || echo "$body"
          
          if [ "$http_status" != "200" ]; then
            echo "::error::Selftest failed with HTTP status $http_status"
            exit 1
          fi
          
          # Parse failure rate from response (using printf instead of bc)
          failure_rate=$(echo "$body" | jq -r '.failure_rate // 0' 2>/dev/null || echo "0")
          failure_rate_int=$(printf "%.0f" "${failure_rate:-0}" 2>/dev/null || echo "0")
          
          echo "Failure Rate: ${failure_rate}%"
          
          # Fail the workflow if failure rate > 50% (critical threshold)
          if [ "$failure_rate_int" -gt 50 ]; then
            echo "::error::Critical failure rate detected: ${failure_rate}%"
            exit 1
          fi
          
          echo "::notice::Selftest completed successfully. Failure rate: ${failure_rate}%"

      - name: Report Results
        if: always()
        run: |
          echo "Selftest execution completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Check Supabase logs and Sentry for detailed results"
